!function(t,e){"use strict";function o(t,e){this.containerElement=t,this.paramContructors=e,this.initialize.call(this)}function i(t){this.scrollTimer=null,this.rows=[],this.rowHeights=[],this.paramContructors=t,this.pageHeight=0,this.renderHeight=0,this.templateHeight=0,this.medianHeight=0,this.scrollTop=0,this.offsetScrollbar=0,this.scrollHeight=0,this.isScrollDown=!1,this.render=function(){},this.selectedRowElement=void 0,this.lastSelectedElement=void 0,this.selectors={flowElement:void 0,$flowTable:t.srcElement,$flowScroll:void 0,$divBody:void 0,fixElement:void 0,$fixTable:void 0,$fixScroll:void 0},this.initialize.call(this)}var r={},n={};App.define("App.ui.datalistModule");var s=function(t,e,o){t.selectedRowElement&&(t.lastSelectedRowElement=t.selectedRowElement),t.selectedRowElement=e,t.paramContructors.options.onselect&&e&&t.paramContructors.options.onselect(o||{},e)},a=function(t,o){o.paramContructors.options.onselecting();var i=e(t.target),r=i.closest("div.datalist-item"),n=r.attr("data-rowid"),a=o.paramContructors.accessor.getBodyView().cache.id(n),l=o.selectors.$divBody[0],c=o.selectors.$divBody.closest(".dt-container"),d=c[0];if(d){var p=i.offset().left-o.selectors.$flowTable.offset().left;p<l.scrollLeft&&(l.scrollLeft=p-10),s(o,a,t)}},l=function(t,o){var i=e(t.target),r=i.closest("div.datalist-item"),n=r.attr("data-rowid"),s=o.paramContructors.accessor.getBodyView().cache.id(n);App.isFunc(o.paramContructors.options.onclick)&&(setTimeout(function(){o.paramContructors.options.onclick({},s)},0),t.preventDefault(),t.stopImmediatePropagation())},c=function(t,o){var i,r,n,s,a,l,c=e(t.target),d=c.closest("div.datalist-item"),p=d.attr("data-rowid"),h=o.paramContructors.accessor.getBodyView().cache.id(p),f=function(t){return e(t.element[0]).find(":focusable").toArray()},u=f(h),m={Tab:9,ArrowDown:40,ArrowUp:38};if(u.length<=0)return!1;if(t.keyCode===m.ArrowDown){if(r=o.paramContructors.accessor.getBodyView().cache.rowids.indexOf(p),i=u.indexOf(c[0]),n=r+1,n===o.paramContructors.accessor.getBodyView().cache.rowids.length)return;s=o.paramContructors.accessor.getBodyView().cache.index(n),u=f(s,o),u.length>0&&u[i].focus(),t.preventDefault(),t.stopImmediatePropagation()}else if(t.keyCode===m.ArrowUp){if(r=o.paramContructors.accessor.getBodyView().cache.rowids.indexOf(p),i=u.indexOf(c[0]),a=r-1,0>a)return;l=o.paramContructors.accessor.getBodyView().cache.index(a),u=f(l,o),u.length>0&&(o.paramContructors.options.ontabing(),u[i].focus(),o.paramContructors.options.ontabed(),t.preventDefault(),t.stopImmediatePropagation())}};o.prototype.initialize=function(){var t=this;t.flowElement=t.containerElement[0]},o.prototype.addChangeEvent=function(t){this.containerElement.on("change","div.datalist-item",t)},o.prototype.detachChangeEvent=function(){this.containerElement.off("change")},o.prototype.addKeyDownEvent=function(t){this.containerElement.on("keydown",t)},o.prototype.addCellClickEvent=function(t){this.containerElement.on("click",t)},o.prototype.detachCellClickEvent=function(){this.containerElement.off("click")},o.prototype.addCellFocusEvent=function(t){this.containerElement.on("focus","div.datalist-item",t)},o.prototype.detachCellFocusEvent=function(){this.containerElement.off("focus","div.datalist-item")},o.prototype.addCellBlurEvent=function(t){this.containerElement.on("blur","div.datalist-item",t)},o.prototype.detachCellBlurEvent=function(){this.containerElement.off("blur","div.datalist-item")},o.prototype.showColumn=function(){},o.prototype.hideColumn=function(){},i.prototype.initialize=function(){var t,e,o=this;if(o.paramContructors.srcElement.is("table"))throw"HTML テーブルレイアウトはサポートされない.";o.paramContructors.containerElements.length>1?(o.selectors.fixElement=o.paramContructors.containerElements[0],o.selectors.flowElement=o.paramContructors.containerElements[1]):o.selectors.flowElement=o.paramContructors.containerElements[0],t=o.selectors.flowElement.closest(".dt-container"),e=o.selectors.$flowTable.wrap("<div class='dt-body'></div>").parent(),o.selectors.$flowScroll=o.selectors.$flowTable.wrap("<div class='dt-vscroll'></div>").parent(),o.selectors.$divBody=e;var i=e[0].offsetWidth-o.selectors.$flowScroll[0].offsetWidth;i>0&&(n.scrollBar.width=i),e.outerHeight(o.paramContructors.options.height),o.medianHeight=o.templateHeight=r.single$(t,"div.item-tmpl").outerHeight(),r.single$(t,"div.item-tmpl").hide(),o.selectors.$flowTable.css({position:"absolute",top:0}),o.addScrollEvent(function(t){o.scrollTimer&&clearTimeout(o.scrollTimer),o.scrollTimer=setTimeout(function(){var t=e.scrollTop();t!==o.scrollTop&&(o.render({scrollTop:t,scrollOffset:t-o.scrollTop}),o.scrollTop=t)},5),t.preventDefault(),t.stopImmediatePropagation()})},i.prototype.getSelectedRow=function(){return this.selectedRowElement},i.prototype.getLastSelectedRow=function(){return this.lastSelectedRowElement},i.prototype.recalc=function(t){var e=this,o=e.selectors.flowElement.closest(".dt-container");e.templateHeight=r.single$(o,"div.item-tmpl").outerHeight(),e.rowHeights=[],e.rowHeights.push(e.templateHeight),(t||[]).forEach(function(t){t.height&&e.rowHeights.push(t.height)}),e.medianHeight=App.num.median(this.rowHeights),(t||[]).forEach(function(t){t.templateHeight||(t.temporaryHeight=e.medianHeight)}),e.renderHeight=0,e.pageHeight=0,(t||[]).forEach(function(t){e.addContainerHeight(t.height||t.temporaryHeight)}),e.lastApplyPageHeight=0,e.adjustContainerHeight()},i.prototype.getPhysicalHeight=function(){return this.selectors.$divBody[0].clientHeight},i.prototype.getRowIndex=function(t){var e,o,i=this,r=i.selectors.$flowTable.children(),n=r.length;for(e=0;n>e;e++)if(o=r[e],o.getAttribute("data-rowid")===t){e--;break}return e},i.prototype.clear=function(){var t=this;t.pageHeight=0,t.renderHeight=0,t.scrollTop=0,t.scrollHeight=0,t.lastApplyPageHeight=void 0,t.selectedRowElement=void 0,t.lastSelectedRowElement=void 0,t.medianHeight=t.templateHeight,t.rows.forEach(function(t){var e=t.containerElement[0];e.parentNode.removeChild(e),e=t.containerElement[1],e&&e.parentNode.removeChild(e)}),t.rows=[],t.rowHeights=[],t.rowHeights.push(t.templateHeight),t.selectors.$flowScroll[0].parentNode.scrollTop=0,t.selectors.$flowScroll[0].style.height="0px",t.setContainerOffset(0)},i.prototype.clearBodyRows=function(){var t,e=this;e.rows.forEach(function(o){t=o.containerElement[0],e.selectors.$flowTable[0].removeChild(t)}),e.rows=[],e.renderHeight=0},i.prototype.removeRow=function(t){var e=this,o=e.rows[t],i=e.paramContructors.accessor.getBodyView().cache.id(o.rowid);return o.detachCellFocusEvent(),o.detachCellClickEvent(),o.detachChangeEvent(),o.detachCellBlurEvent(),App.isUndefOrNull(o.containerElement[0].parentNode)||o.containerElement[0].parentNode.removeChild(o.containerElement[0]),e.rows.splice(t,1),i.visible=!1,e.selectedRowElement===i&&(e.selectedRowElement=void 0),e.lastSelectedRowElement===i&&(e.lastSelectedRowElement=void 0),i},i.prototype.resizeFitToBottom=function(t,o,i,r,n,s,a,l){t.resizeTimer&&clearTimeout(t.resizeTimer),t.resizeTimer=setTimeout(function(){var r=o.offset().top,n=e(window).height(),s=Math.floor(n-r-t.paramContructors.options.resizeOffset);i.height(s),s>t.viewHeight?i.closest(".part").css("margin-bottom","0px"):i.closest(".part").css("margin-bottom","32px"),App.isFunc(l)&&l()},5)},i.prototype.resize=function(t){var e=this,o=e.selectors.flowElement.closest(".dt-container"),i=r.single$(e.selectors.flowElement,".dt-body");e.resizeFitToBottom(e,o,i,void 0,void 0,void 0,void 0,t)},i.prototype.getScrollTop=function(){return this.selectors.$flowScroll[0].parentNode.scrollTop},i.prototype.setContainerOffset=function(t){var e=this;e.selectors.$flowTable.css("top",t)},i.prototype.addContainerOffset=function(t){var e=this,o=Math.max(parseInt(e.selectors.$flowTable.css("top"),10)+t,0);e.setContainerOffset(o)},i.prototype.syncScrollPosition=function(){return!1},i.prototype.getDOMRowIdAttribute=function(t){var o,i=e(t);return o=i.attr("data-rowid")},i.prototype.isDisplayDataRow=function(t){var e,o,i,r=this;for(e=0,o=r.rows.length;o>e;e++)if(i=r.rows[e],t.rowid===i.rowid)return!0;return!1},i.prototype.cloneTemplateItem=function(){var t,e=this,o=r.single$(e.selectors.$divBody,"div.item-tmpl");if(o.length<=0)throw"テンプレートが存在しない";return t=r.cloneNode(o),[void 0,t]},i.prototype.addContainerHeight=function(t,e){var o=this;o.pageHeight+=t,e&&(o.pageHeight-=e)},i.prototype.adjustContainerHeight=function(){var t=this;t.pageHeight!==t.lastApplyPageHeight&&(t.selectors.$flowScroll[0].style.height=t.pageHeight+"px",t.lastApplyPageHeight=t.pageHeight)},i.prototype.attachEventToBodyRow=function(t){var o=this;t.addChangeEvent(function(o){var i=e(o.target),r=i.closest("div.datalist-item"),n=r.attr("data-rowid"),s=t.paramContructors.accessor.getBodyView().cache.id(n);t.paramContructors.options.onchange&&s&&t.paramContructors.options.onchange(o,s)}),t.addCellBlurEvent(function(t){o.hasFocus=!1,t.preventDefault(),t.stopImmediatePropagation()}),t.addCellFocusEvent(function(t){o.hasFocus=!0,a(t,o),t.preventDefault(),t.stopImmediatePropagation()}),t.addCellClickEvent(function(t){a(t,o),l(t,o)}),t.addKeyDownEvent(function(e){c(e,t)})},i.prototype.insertRow=function(t,e){var i,n=this,s=n.selectors.$flowTable[0],a=new o(e.element,n.paramContructors),l=!1;if(n.attachEventToBodyRow(a),a.rowid=e.rowid,i=a.containerElement[0],t>=n.rows.length?(s.appendChild(i),e.height||(e.height=i.clientHeight,l=!0),n.rows.push(a)):(s.insertBefore(i,n.rows[t].containerElement[0]),e.height||(e.height=i.clientHeight,l=!0),n.rows.splice(t,0,a)),l&&(this.rowHeights.push(e.height),this.medianHeight=App.num.median(this.rowHeights),n.addContainerHeight(e.height,e.temporaryHeight)),App.isNumeric(n.indexColumnHide))a.hideColumn(n.indexColumnHide);else{var c,d,p,h=r.query(e.element,"div.row");for(c=0,d=h.length;d>c;c++)p=h[c],r.query$(p,"div").css("display","")}},i.prototype.redrawRow=function(t){var e=this,o=t.element[0].clientHeight;e.addContainerHeight(o,t.height),e.adjustContainerHeight(),t.height!==o&&(t.height=o)},i.prototype.addScrollEvent=function(t){this.selectors.$divBody.on("scroll",t)},i.prototype.detachScrollEvent=function(){this.selectors.$divBody.off("scroll")},App.ui.datalistModule=function(){return r=e.fn.dataTable.DOMUtil,n=e.fn.dataTable.BrowserSupport,{HeaderContainer:e.fn.dataTable.emptyHeaderContainer,BodyContainer:i,FooterContainer:e.fn.dataTable.emptyFooterContainer}}}(this,jQuery);